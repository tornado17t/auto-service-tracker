<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Авто-Сервис Трекер</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f9; }
h1 { text-align: center; margin-bottom: 20px; }
input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; }
button { cursor: pointer; }
ul { list-style: none; padding: 0; margin-top: 20px; }
li { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
.record-info { flex: 1; }
.delete-btn { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }

/* Всплывающее уведомление внутри страницы */
.inpage-notif {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #2ecc71;
  color: #fff;
  padding: 10px 20px;
  border-radius: 5px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  z-index: 1000;
}

/* Список автомобилей с кнопками удаления */
.car-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
.car-item button { background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; }

/* Статистика затрат */
#statsContainer { margin-top: 20px; background: #fff; padding: 10px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<h1>Авто-Сервис Трекер</h1>

<h3>Добавить автомобиль</h3>
<input type="text" id="carName" placeholder="Название машины">
<input type="number" id="carYear" placeholder="Год выпуска">
<input type="text" id="carNumber" placeholder="Номер машины">
<button id="addCarBtn">Добавить автомобиль</button>

<h3>Ваши автомобили</h3>
<div id="carListContainer"></div>

<h3>Добавить запись по сервису</h3>
<select id="carSelect">
  <option value="">Выберите автомобиль</option>
</select>
<input type="text" id="service" placeholder="Работа (например: замена масла)">
<input type="number" id="mileage" placeholder="Пробег (км)">
<input type="number" id="cost" placeholder="Стоимость работы (грн)">
<input type="date" id="reminderDate" placeholder="Дата напоминания">
<button id="addRecord">Добавить запись</button>

<ul id="recordsList"></ul>

<h3>Статистика затрат</h3>
<div id="statsContainer">
  <p id="totalCost">Общая сумма: 0 грн</p>
  <div id="monthlyCost"></div>
</div>

<script>
// Элементы
const carNameInput = document.getElementById('carName');
const carYearInput = document.getElementById('carYear');
const carNumberInput = document.getElementById('carNumber');
const addCarBtn = document.getElementById('addCarBtn');
const carSelect = document.getElementById('carSelect');
const serviceInput = document.getElementById('service');
const mileageInput = document.getElementById('mileage');
const costInput = document.getElementById('cost');
const reminderDateInput = document.getElementById('reminderDate');
const addRecordBtn = document.getElementById('addRecord');
const recordsList = document.getElementById('recordsList');
const carListContainer = document.getElementById('carListContainer');
const totalCostEl = document.getElementById('totalCost');
const monthlyCostEl = document.getElementById('monthlyCost');

// Данные
let cars = JSON.parse(localStorage.getItem('cars') || '[]');
let recordsByCar = JSON.parse(localStorage.getItem('recordsByCar') || '{}');

// Функции
function updateCarSelect() {
  carSelect.innerHTML = '<option value="">Выберите автомобиль</option>';
  cars.forEach(car => {
    const option = document.createElement('option');
    option.value = car.id;
    option.textContent = `${car.name} (${car.year}) [${car.number}]`;
    carSelect.appendChild(option);
  });

  // Список автомобилей с кнопками удаления
  carListContainer.innerHTML = '';
  cars.forEach(car => {
    const div = document.createElement('div');
    div.className = 'car-item';
    div.innerHTML = `<span>${car.name} (${car.year}) [${car.number}]</span><button>Удалить</button>`;
    div.querySelector('button').addEventListener('click', () => {
      if (confirm(`Удалить автомобиль ${car.name}? Все его записи будут удалены!`)) {
        // Удаляем автомобиль
        cars = cars.filter(c => c.id !== car.id);
        localStorage.setItem('cars', JSON.stringify(cars));
        // Удаляем его записи
        delete recordsByCar[car.id];
        localStorage.setItem('recordsByCar', JSON.stringify(recordsByCar));
        // Сбрасываем выбор и список записей, если выбран удаляемый автомобиль
        if (carSelect.value === car.id) {
          carSelect.value = '';
          recordsList.innerHTML = '';
        }
        updateCarSelect();
        renderRecords();
      }
    });
    carListContainer.appendChild(div);
  });
}

function renderRecords() {
  const selectedCarId = carSelect.value;
  recordsList.innerHTML = '';
  if (!selectedCarId || !recordsByCar[selectedCarId]) {
    updateStats();
    return;
  }
  recordsByCar[selectedCarId].forEach(r => {
    const li = document.createElement('li');
    li.dataset.id = r.id;
    li.innerHTML = `
      <div class="record-info">
        <strong>${r.service}</strong><br>
        Пробег: ${r.mileage} км<br>
        Стоимость: ${r.cost} грн<br>
        Дата напоминания: ${r.reminderDate || 'не указана'}
      </div>
      <button class="delete-btn">Удалить</button>
    `;
    recordsList.appendChild(li);
  });
  updateStats();
}

// Добавление автомобиля
addCarBtn.addEventListener('click', () => {
  const name = carNameInput.value.trim();
  const year = carYearInput.value.trim();
  const number = carNumberInput.value.trim();
  if (!name || !year || !number) {
    alert("Заполните все поля для автомобиля!");
    return;
  }
  const newCar = { id: Date.now().toString(), name, year, number };
  cars.push(newCar);
  localStorage.setItem('cars', JSON.stringify(cars));
  carNameInput.value = carYearInput.value = carNumberInput.value = '';
  updateCarSelect();
});

// Добавление записи
addRecordBtn.addEventListener('click', () => {
  const carId = carSelect.value;
  const service = serviceInput.value.trim();
  const mileage = mileageInput.value.trim();
  const cost = costInput.value.trim();
  const reminderDate = reminderDateInput.value;
  if (!carId || !service || !mileage || !cost) {
    alert("Заполните все поля для записи!");
    return;
  }
  const newRecord = {
    id: Date.now().toString(),
    service,
    mileage,
    cost,
    reminderDate,
    notified: false
  };
  if (!recordsByCar[carId]) recordsByCar[carId] = [];
  recordsByCar[carId].push(newRecord);
  localStorage.setItem('recordsByCar', JSON.stringify(recordsByCar));
  serviceInput.value = mileageInput.value = costInput.value = reminderDateInput.value = '';
  renderRecords();
});

// Удаление записи
recordsList.addEventListener('click', e => {
  if (e.target.classList.contains('delete-btn')) {
    const li = e.target.closest('li');
    const id = li.dataset.id;
    const carId = carSelect.value;
    recordsByCar[carId] = recordsByCar[carId].filter(r => r.id !== id);
    localStorage.setItem('recordsByCar', JSON.stringify(recordsByCar));
    renderRecords();
  }
});

// Всплывающее уведомление внутри страницы
function showInPageNotification(message) {
  const notif = document.createElement('div');
  notif.textContent = message;
  notif.className = 'inpage-notif';
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 5000);
}

// Проверка уведомлений (ПК + мобильные)
function checkNotifications() {
  const today = new Date().toISOString().split('T')[0];
  cars.forEach(car => {
    const records = recordsByCar[car.id] || [];
    records.forEach(r => {
      if (r.reminderDate && r.reminderDate <= today && !r.notified) {
        // Системное уведомление (ПК)
        if ("Notification" in window && Notification.permission === "granted") {
          new Notification("Напоминание о ТО", {
            body: `${r.service} для ${car.name} (${car.number}). Стоимость: ${r.cost} грн`
          });
        } else {
          // Всплывающее уведомление на странице (мобильные)
          showInPageNotification(`Напоминание: ${r.service} для ${car.name} (${car.number}). Стоимость: ${r.cost} грн`);
        }
        r.notified = true;
      }
    });
  });
  localStorage.setItem('recordsByCar', JSON.stringify(recordsByCar));
}

// Статистика затрат
function updateStats() {
  const selectedCarId = carSelect.value;
  monthlyCostEl.innerHTML = '';
  
  if (!selectedCarId || !recordsByCar[selectedCarId] || recordsByCar[selectedCarId].length === 0) {
    totalCostEl.textContent = 'Общая сумма: 0 грн';
    return;
  }

  const records = recordsByCar[selectedCarId];
  let total = 0;
  const monthly = {};

  records.forEach(r => {
    const cost = parseFloat(r.cost) || 0;
    total += cost;
    if (r.reminderDate) {
      const month = r.reminderDate.slice(0,7); // yyyy-mm
      if (!monthly[month]) monthly[month] = 0;
      monthly[month] += cost;
    }
  });

  totalCostEl.textContent = `Общая сумма: ${total} грн`;

  for (const month in monthly) {
    const p = document.createElement('p');
    p.textContent = `${month}: ${monthly[month]} грн`;
    monthlyCostEl.appendChild(p);
  }
}

// Инициализация
window.onload = () => {
  updateCarSelect();
  renderRecords();
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }
  setInterval(checkNotifications, 30000);
};

// Обновление списка записей при смене автомобиля
carSelect.addEventListener('change', renderRecords);
</script>

</body>
</html>
